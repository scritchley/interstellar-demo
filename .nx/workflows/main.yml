resourceClass: docker_linux_amd64/small
env:
  CI: 'true'
  NODE_OPTIONS: '--max_old_space_size=4096'
steps:
  - name: Git Checkout
    env:
      GIT_CHECKOUT_DEPTH: 100
    uses: nrwl/nx-cloud-workflows/v1.0/workflow-steps/checkout/main.yaml

  - name: NPM Install
    script: |
      npm ci

  - name: Nx Run Many
    script: |
      export NX_BASE=$(git merge-base main HEAD)
      npx nx affected:lint --base=$(NX_BASE) --dte &
      npx nx affected:test --base=$(NX_BASE) --dte &
      npx nx affected:build --base=$(NX_BASE) --dte &
      wait
      npx nx-cloud stop-all-agents
