resourceClass: docker_linux_amd64/small
env:
  CI: 'true'
  NODE_OPTIONS: '--max_old_space_size=4096'
steps:
  - name: Git Checkout
    script: |
      git init .
      git remote add origin $GIT_REPOSITORY_URL
      git fetch --prune --progress --no-recurse-submodules origin +refs/heads/*:refs/remotes/origin/* +refs/tags/*:refs/tags/*
      git checkout --progress --force -B {{nxBranch}} refs/remotes/origin/{{nxCommitRef}}

  - name: NPM Install
    script: |
      npm ci

  - name: Nx Run Many
    script: |
      export NX_BASE=$(git merge-base refs/remotes/origin/main HEAD)
      echo $NX_BASE
      npx nx affected:lint --base=$NX_BASE --dte &
      P1=$!
      npx nx affected:test --base=$NX_BASE --dte &
      P2=$!
      npx nx affected:build --base=$NX_BASE --dte &
      P3=$!
      wait $P1 $P2 $P3
      npx nx-cloud stop-all-agents
